#summary Utilisation des EJBs.

= Utilisation avec des EJB =
Les EJB ont deux facettes : le client et le serveur. 
Les deux composants peuvent être installé dans le même serveur d'applications, ou dans des serveurs
différents. Les annuaires des deux serveurs peuvent [architecture séparées ou unifiés].

== Serveur EJB ==
Un composant EAR qui publie des EJBs doit les déclarer dans le fichier `ejb-jar.xml`.
{{{
<ejb-jar
  id="compta" 
>
  ...
  <display-name>jndi-ejb-sample</display-name>
  <enterprise-beans>
    <session>
      <display-name>Lookup JNDI</display-name>
      <ejb-name>Paye</ejb-name>
      <home>fr.prados.PayeHome</home>
      <remote>fr.prados.Paye</remote>
      <ejb-class>fr.prados.PayeSession</ejb-class>
      <session-type>Stateless</session-type>
      <transaction-type>Container</transaction-type>
    </session>
  <enterprise-beans>
<ejb-jar>
}}}
Notez la valeur du paramètre `id` du marqueur `<ejb-jar/>`. Il correspond à l'identifiant du composant.

Nous souhaitons bénéficier de la normalisation du packaging du composant, 
à savoir, la possibilité de l'utiliser sur tous les serveurs d'applications, 
indépendamment de sa marque, de sa version ou de son architecture. 
C'est bien l'objectif de la normalisation EAR.

Suivant les serveurs d'applications, il faut ajouter [transformerWebXML différents] 
fichiers permettant d'associer la ressource `java:comp/env/ejb/Paye` avec une autre clef JNDI.

Pour JBoss, il faut ajouter le fichier `META-INF/jboss.xml` suivant :
{{{
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE jboss
  PUBLIC "-//JBoss//DTD JBOSS 3.0//EN" "http://www.jboss.org/j2ee/dtd/jboss_3_0.dtd">
<jboss>
   <enterprise-beans>
      <session>
         <ejb-name>Paye</ejb-name>
         <jndi-name>compta/ejb/Paye</jndi-name>
    </session>
  </enterprise-beans>
</jboss>
}}}

L'archive ainsi produite est alors packagé dans un EAR.

== Client d'EJB ==
L'annuaire JNDI de la compta est généralement distant de l'annuaire de l'Intranet mais peut
également être [architecture le même] que l'annuaire du client. 

Coté client, on retrouve dans le fichier `web.xml`, le besoin d'avoir une référence sur l'EJB.
{{{
<web-app>
...
  <ejb-ref>
    <description>L'EJB de paye</description>
    <ejb-ref-name>ejb/Paye</ejb-ref-name>
    <ejb-ref-type>Session</ejb-ref-type>
    <home>fr.prados.PayeHome</home>
    <remote>fr.prados.Paye</remote>
  </ejb-ref>
</web-app>
}}}

Les fichiers spécifiques aux différents serveurs d'applications peuvent être généré à l'aide de [transformerWebXML filtre XSLT]. 
L'idée est de généré un mapping systématique entre un nom de la branche `java:comp/env/...` 
vers un nom de la forme `java:<id>....` Par exemple, le fichier `jboss-web.xml` peut être le suivant :
{{{
<jboss-web>
...
   <ejb-ref>
      <ejb-ref-name>ejb/Paye</ejb-ref-name>
      <jndi-name>java:/intranet/ejb/Paye</jndi-name>
   </ejb-ref>
</jboss-web>
}}}

Il faut maintenant déclarer les besoins en ressources dans le fichier `jndi-resources.xml`. 
Nous souhaitons un lien vers l'annuaire distant de la Compta, puis un lien entre la clef 
locale `java:/intranet/ejb/Paye` et l'EJB de paye.
{{{
<!-- Lien vers l'annuaire JNDI de la compta -->
<resource name="/compta" familly="jndi/default"/>

<!-- Lien d'une clef locale vers la clef de l'annaire de la compta -->
<resource name="intranet/ejb/Paye" familly="link/default">
 <property name="link" value="/compta/compta/ejb/LookupJndi"/>
</resource>
}}}

Rien n'indique la location de la compta, s'il y a utilisation du même annuaire ou de 
deux annuaires. Lors de l'installation les choix de l'architecture de déploiement seront 
effectué. Par exemple, lors de l'installation du client de l'EJB, il faut valoriser la variable 
`jndi.url`.
{{{
>$JNDI_HOME/bin/jndi-install \
        --appsrv jboss --version 5.0 \
        --package ./package \
        --dest jboss.server.home=/opt/jboss-5.0
        --dest jboss.server.conf=/opt/jboss-5.0/server/default \
        -P platform.properties
        -D jndi.url=jnp://comptahost:1099
}}}

Précédent : [exemple Exemple]
Suite : [familles Les familles de ressources]